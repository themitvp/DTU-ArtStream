<!DOCTYPE html>
<html lang="en" ng-app="raspberryPiApp" ng-controller="mainController">
<head>
	<meta charset="UTF-8">
	<script src="js/jquery-1.12.3.min.js"></script>
	<script src="js/jquery-migrate-1.2.1.min.js"></script>
	<script src="js/angular.min.js"></script>
	<script src="js/angular-animate.min.js"></script>
	<style type="text/css">
		html {
			box-sizing: border-box;
		}
		*, *:before, *:after {
			box-sizing: inherit;
		}

		html, body {
			margin: 0;
			width: 100vw;
			height: 100vh;
			display: table-cell;
			vertical-align: middle;
			background: #000;
			overflow: hidden;
		}

		.fullscreen {
			margin: auto;
			display: block;
			max-height: 100%;
			max-width: 100%;
			height: auto;
		}

		.menu {
			position: absolute;
			top: 10%;
			left: 10%;
			width: 80%;
			height: 80%;
			background: rgba(255, 255, 255, 0.95);
			border: 2px solid #2F2F2F;
			border-radius: 5px;
			overflow: auto;
		}

		.menu.ng-enter,
		.menu.ng-leave.ng-leave-active {
			opacity:0;
		}

		.menu.ng-leave,
		.menu.ng-enter.ng-enter-active {
			opacity:1;
		}

		.menu .menu-inner {
			padding: 0 30px;
			height: 100%;
			width: 100%;
			display: table;
		}

		.menu .menu-inner h1 {
			margin: 0;
			font-size: 50px;
		}

		.menu .menu-inner .dead-center {
			display: table-cell;
			vertical-align: middle;
			text-align: center;
		}

		.menu table {
			width: 100%;
		}

		.art-item {
			
			width: 25%;
			vertical-align: middle;
			border: 1px solid transparent;
			padding: 25px;
		}

		.art-item img {
			max-width: 100%;
			max-height: 100%;
			height: auto;
			margin: 0 auto;
			display: block;
		}

		.highlight {
			background: #dedede;
			border-color: #A0A0A0;
		}

		.title {
			color: #1A5286;
		}
	</style>
</head>
<body class="ng-cloak" ng-keydown="openMenu($event)">
	<img class="fullscreen" ng-src="{{images[selectImage]}}">
	
	<div ng-if="showMenu" class="menu">
		<div class="menu-inner">
			<h1>Menu</h1>
			<!--<p>Dismiss Timer: {{countDown}}s</p>-->
			
			<table>
				<tr ng-repeat="row in imageGrid" ng-init="indexY = $index">
					<td class="art-item" ng-repeat="item in row" ng-init="indexX = $index" ng-class="{'highlight': indexX == focusIndexX && indexY == focusIndexY }">
						<img ng-src="{{item}}">
					</td>
				</tr>
			</table>
		</div>
	</div>

	<div ng-if="showSetup" class="menu">
		<div class="menu-inner">
			<div class="dead-center">
				<div class="title">
					<h1>Welcome to ArtStream</h1>
					<h3>The Digital Art Experience</h3>
				</div>
				<div ng-hide="pin">
					<h3>To get started please enter the following URL or scan the QR code on any device:</h3>
					<!--<h1><strong>{{url}}</strong></h1>-->
					<h2><strong>192.168.2.10/setup</strong></h2>
					<qr text="url" size="120"></qr>
				</div>
				<div ng-show="pin">
					<br/>
					<?xml version="1.0" ?><svg height="48" viewBox="0 0 48 48" width="48" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h48v48h-48z" fill="none" opacity=".1"/><path d="M0 0h48v48h-48z" fill="none"/><path d="M2 36v6h6c0-3.31-2.69-6-6-6zm0-8v4c5.52 0 10 4.48 10 10h4c0-7.73-6.27-14-14-14zm36-14h-28v3.27c7.92 2.56 14.17 8.81 16.73 16.73h11.27v-20zm-36 6v4c9.94 0 18 8.06 18 18h4c0-12.15-9.85-22-22-22zm40-14h-36c-2.21 0-4 1.79-4 4v6h4v-6h36v28h-14v4h14c2.21 0 4-1.79 4-4v-28c0-2.21-1.79-4-4-4z"/></svg>
					<h2><strong>You are now connected</strong></h2>
					<h3><strong>Please enter the following PIN:</strong></h3>
					<h1>{{pin}}</h1>
				</div>
			</div>
		</div>
	</div>
	
	<script src="js/qrcode.js"></script>
	<script src="js/angular-qr.min.js"></script>
	<script src="js/socket.io.js"></script>
	<script type="text/javascript">
		var app = angular.module('raspberryPiApp', ['ngAnimate', 'ja.qr']);

		app.controller('mainController', function ($scope, $interval) {
			var loc = window.location;
			$scope.name = null;
			$scope.location = null;
			$scope.selectImage = 0;
			$scope.focusIndexX = 0;
			$scope.focusIndexY = 0;
			$scope.showMenu = false;
			$scope.showSetup = false;
			$scope.url = null;
			$scope.pin = null;

			$scope.images = [];
			for (var i=1; i <= 12; i++) {
				$scope.images.push("img/img" + i + ".jpeg");
			};

			$scope.imageGrid = [];

			for (var i=0; i < $scope.images.length; i++) {
				if (i%4 == 0) {
					$scope.imageGrid.push([]);
				}
				$scope.imageGrid[$scope.imageGrid.length-1].push($scope.images[i]);
			}
			console.log($scope.imageGrid);

			$scope.openMenu = function(event) {
				if ($scope.showSetup != true && (event.keyCode == '37' || event.keyCode == '38' || event.keyCode == '39' || event.keyCode == '40' || event.keyCode == '13')) {

					if ($scope.showMenu == false) {
						$scope.showMenu = true;

						var startTime = Date.now();
						$scope.countDown = 4;
						var promise;

						var tick = function() {
							$scope.countDown -= 1;
							$scope.clock = Date.now();
							if ($scope.clock > startTime + 3000 ) {
								$scope.showMenu = false;
								$interval.cancel(promise);
							}
						}

						tick();
						//promise = $interval(tick, 1000);
					} else {
						// LEFT
						if (event.keyCode == '37' && $scope.focusIndexX != 0) { $scope.focusIndexX--; }
						
						// RIGHT
						if (event.keyCode == '39' && $scope.focusIndexX != 3) { $scope.focusIndexX++; }

						// UP
						if (event.keyCode == '38' && $scope.focusIndexY != 0) { $scope.focusIndexY--; }

						// DOWN
						if (event.keyCode == '40' && $scope.focusIndexY != 2) { $scope.focusIndexY++; }

						// ENTER
						if (event.keyCode == '13') { 
							$scope.selectImage = 4 * $scope.focusIndexY + $scope.focusIndexX; 
							$scope.showMenu = false;
						}
					}
				}
			};

			$scope.open = function ( index ) {
				var record = $scope.shownRecords[ index ]
				console.log('opening : ', record );
			};

			var socket = io.connect();
			socket.on('setupEnter', function (pin) {
				$scope.$apply(function () {
					$scope.pin = pin;
				});
			});
			socket.on('setupSave', function (data) {
				$scope.$apply(function () {
					$scope.name = data.name;
					$scope.location = data.location;
					$scope.showSetup = false;
				});
			});
			socket.on('setupUrl', function (url) {
				$scope.$apply(function () {
					$scope.url = url;
				});
			})
			socket.emit('setupUrl');
		});
	</script>
</body>
</html>